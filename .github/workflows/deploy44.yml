name: Build & Deploy Java App to AWS Elastic Beanstalk

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Build with Maven
      run: mvn clean package

    - name: Prepare deployment bundle
      run: |
        # Copy JAR to root and create Procfile
        cp target/*.jar application.jar
        echo 'web: java -jar application.jar' > Procfile
        
        # Create zip with root-level files
        zip -j app.zip application.jar Procfile
        # Add .ebextensions if exists
        [ -d .ebextensions ] && zip -r app.zip .ebextensions/

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}

    - name: Upload zip to S3
      run: |
        aws s3 cp app.zip s3://${{ secrets.EB_S3_BUCKET }}/java_app-${{ github.run_number }}.zip

    - name: Install AWS EB CLI
      run: |
        pip install --upgrade pip
        pip install awsebcli

    - name: Create new Elastic Beanstalk app version
      run: |
        aws elasticbeanstalk create-application-version \
          --application-name ${{ secrets.EB_APP_NAME }} \
          --version-label v-${{ github.run_number }} \
          --source-bundle S3Bucket=${{ secrets.EB_S3_BUCKET }},S3Key=java_app-${{ github.run_number }}.zip

    - name: Initialize EB CLI
      run: |
        eb init ${{ secrets.EB_APP_NAME }} \
          --platform "64bit Amazon Linux 2023 v4.5.2 running Corretto 21" \
          --region ${{ secrets.AWS_REGION }}

    - name: Cleanup existing environment
      run: |
        if eb status java | grep -q 'Environment details'; then
          eb terminate java --force
          sleep 120  # Wait for environment termination
        fi

    - name: Deploy new version
      run: |
        eb deploy java \
          --version v-${{ github.run_number }} \
          --timeout 20
